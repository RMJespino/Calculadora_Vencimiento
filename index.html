<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Vencimiento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #9d50bb, #6e48aa);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      font-family: 'Poppins', sans-serif;
      padding: 20px;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
    }
    .titulo {
      font-weight: 600;
      color: #6e48aa;
      text-align: center;
    }
    .firma {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 0.9em;
      color: #ffffff;
      opacity: 0.7;
    }
    .firma:hover {
      opacity: 1;
    }
    .alert-success {
      background-color: #d9ede1;
      border: 1px solid #c1dccd;
      color: #333333;
      font-size: 1rem;
    }
    .fecha-final {
      font-size: 2.5rem;
      font-weight: 700;
      color: #6e48aa;
      text-align: center;
      margin: 10px 0;
    }
    .texto-detalle {
      text-align: justify;
      color: #333333;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2 class="titulo mb-4">Calculadora de Fecha de Vencimiento</h2>

    <div class="mb-3">
      <label for="producto" class="form-label">Selecciona el producto:</label>
      <select class="form-select" id="producto" onchange="mostrarCampos()">
        <option value="">-- Elegir --</option>
        <option value="Anchor">Anchor</option>
        <option value="Gloria">Gloria</option>
      </select>
    </div>



    <div id="camposAnchor" class="d-none">
      <div class="mb-3">
        <label for="envasadoA" class="form-label">Fecha de envasado:</label>
        <input type="date" class="form-control" id="envasadoA">
      </div>
      <div class="mb-3">
        <label for="vitaminaA" class="form-label">Fecha de vencimiento de la vitamina:</label>
        <input type="date" class="form-control" id="vitaminaA">
      </div>
    </div>

    <div id="camposGloria" class="d-none">
      <div class="mb-3">
        <label for="fabricacionB" class="form-label">Fecha de envasado:</label>
        <input type="date" class="form-control" id="fabricacionB">
      </div>
      <div class="mb-3">
        <label for="conservanteB" class="form-label">Fecha de vencimiento del granel:</label>
        <input type="date" class="form-control" id="conservanteB">
      </div>
<div class="mb-3 d-none" id="campoCodigoExtra">
  <label for="codigoExtra" class="form-label">Inicial Pais Origen:</label>
  <input type="text" class="form-control" id="codigoExtra" maxlength="1">
</div>
    </div>

    <div class="d-flex justify-content-center gap-2 my-3">
      <button class="btn btn-primary" onclick="calcular()">Calcular</button>
      <button class="btn btn-secondary" onclick="limpiar()">Limpiar</button>
    </div>

    <div class="alert alert-warning d-none" id="notaAnchor">
      <strong>Nota:</strong> Si la fecha de vencimiento indicada para la vitamina es menor a 9 meses contados desde la fecha de envasado, deberá codificarse esa fecha como vencimiento del producto. En caso contrario, se debe codificar la fecha de vencimiento establecida por el Reglamento Sanitario, que corresponde a 9 meses a partir de la fecha de envasado.
    </div>

    <div class="alert alert-warning d-none" id="notaGloria">
      <strong>Nota:</strong> Si la fecha de vencimiento indicada para el granel es menor a 12 meses contados desde la fecha de envasado, deberá codificarse esa fecha como vencimiento del producto. En caso contrario, se debe codificar la fecha de vencimiento establecida por el Reglamento Sanitario, que corresponde a 12 meses a partir de la fecha de envasado.
    </div>

    <div class="alert alert-success d-none" id="resultado"></div>
  </div>

  <div class="firma">Desarrollado por Planta Industrial</div>

  <script>
    function mostrarCampos() {
  const producto = document.getElementById("producto").value;

  // Ocultar todos los campos y mensajes
  document.getElementById("camposAnchor").classList.add("d-none");
  document.getElementById("camposGloria").classList.add("d-none");
  document.getElementById("resultado").classList.add("d-none");
  document.getElementById("notaAnchor").classList.add("d-none");
  document.getElementById("notaGloria").classList.add("d-none");
  document.getElementById("campoCodigoExtra").classList.add("d-none"); // Ocultar por defecto

  if (producto === "Anchor") {
    document.getElementById("camposAnchor").classList.remove("d-none");
    document.getElementById("notaAnchor").classList.remove("d-none");
  } else if (producto === "Gloria") {
    document.getElementById("camposGloria").classList.remove("d-none");
    document.getElementById("notaGloria").classList.remove("d-none");
    document.getElementById("campoCodigoExtra").classList.remove("d-none");
  }

}


    function sumarMeses(fechaStr, meses) {
      const [anio, mes, dia] = fechaStr.split("-");
      const fecha = new Date(anio, mes - 1, dia);
      fecha.setMonth(fecha.getMonth() + meses);
      if (fecha.getDate() < dia) fecha.setDate(0);
      return fecha.toISOString().split("T")[0];
    }

    function calcularDiaJuliano(fechaStr) {
      const fecha = new Date(fechaStr);
      const inicioAno = new Date(fecha.getFullYear(), 0, 0);
      const diferencia = fecha - inicioAno;
      const unDia = 1000 * 60 * 60 * 24;
      return Math.floor(diferencia / unDia) + 1;
    }

    function calcular() {
      const producto = document.getElementById("producto").value;
     let letraCodigo = document.getElementById("codigoExtra").value.toUpperCase();

    // Validar campo obligatorio solo si es Gloria
    if (producto === "Gloria" && (!letraCodigo || !/^[A-Z]$/.test(letraCodigo))) {
    alert("Debes ingresar una letra válida (A-Z) en el campo Inicial Pais Origen.");
    return;
    }

// Si es Anchor, usar código por defecto
if (producto === "Anchor") {
  letraCodigo = "X";
}

      let fechaBase = "", fechaVto = "", mesesLimite = 0;

      if (producto === "Anchor") {
        fechaBase = document.getElementById("envasadoA").value;
        fechaVto = document.getElementById("vitaminaA").value;
        mesesLimite = 9;
      } else if (producto === "Gloria") {
        fechaBase = document.getElementById("fabricacionB").value;
        fechaVto = document.getElementById("conservanteB").value;
        mesesLimite = 12;
      } else {
        alert("Selecciona un producto");
        return;
      }

      if (!fechaBase || !fechaVto) {
        alert("Completa todas las fechas.");
        return;
      }

      const limite = sumarMeses(fechaBase, mesesLimite);
      const resultadoDiv = document.getElementById("resultado");

      let final = "", detalle = "";

      if (fechaVto <= limite) {
        final = fechaVto;
        detalle = `Debido a que la fecha de vencimiento ${
          producto === "Anchor" ? "de la vitamina" : "del granel"
        } es menor a ${mesesLimite} meses desde la fecha de envasado, se utilizará esta misma fecha para el codificado del producto.`;
      } else {
        final = limite;
        detalle = `La fecha ingresada del insumo supera los ${mesesLimite} meses permitidos. Se aplicará la fecha establecida por el Reglamento Sanitario (${mesesLimite} meses desde la fecha de envasado).`;
      }

      const [y, m, d] = final.split("-");
      const fechaFormateada = `${d}/${m}/${y}`;
      const diaJuliano = calcularDiaJuliano(fechaBase);

    let codigoFinal = "";
if (producto === "Anchor") {
  const digitoAnio = new Date().getFullYear().toString().slice(-1);
  const codificado1 = `${digitoAnio}${diaJuliano.toString().padStart(3, "0")}0107 08`;

  const codificado2 = `V ${d.padStart(2, "0")} ${m.padStart(2, "0")} ${y}`;

  codigoFinal = `${codificado1}<br>${codificado2}`;
} else {
  const fechaVtoCompacta = `V${d.padStart(2, "0")}${m.padStart(2, "0")}${y.slice(-2)}`;
  codigoFinal = `${fechaVtoCompacta} ${diaJuliano}${letraCodigo}`;
}

      resultadoDiv.innerHTML = `
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-success me-2">✔</span>
          <strong>La fecha de vencimiento del producto es:</strong>
        </div>
        <div class="fecha-final">${fechaFormateada}</div>

        <div class="d-flex align-items-center mb-2 mt-4">
          <span class="badge bg-success me-2">✔</span>
          <strong>El día juliano del envasado es:</strong>
        </div>
        <div class="fecha-final">${diaJuliano}</div>

        <div class="d-flex align-items-center mb-2 mt-4">
          <span class="badge bg-success me-2">✔</span>
          <strong>Codificado final:</strong>
        </div>
        <div class="fecha-final">${codigoFinal}</div>

        <p class="texto-detalle">${detalle}</p>
        <button id="verFotoBtn" class="btn btn-secondary mt-3">Ver foto del producto</button>
        <div id="imagenProducto" class="mt-3" style="display: none;"></div>
       `;
       resultadoDiv.classList.remove("d-none");
       document.getElementById("notaAnchor").classList.add("d-none");
       document.getElementById("notaGloria").classList.add("d-none");
    }

    function limpiar() {
  document.getElementById("producto").value = "";
  document.getElementById("codigoExtra").value = "";
  document.getElementById("camposAnchor").classList.add("d-none");
  document.getElementById("camposGloria").classList.add("d-none");
  document.getElementById("campoCodigoExtra").classList.add("d-none"); // Ocultar campo código extra
  document.getElementById("envasadoA").value = "";
  document.getElementById("vitaminaA").value = "";
  document.getElementById("fabricacionB").value = "";
  document.getElementById("conservanteB").value = "";
  document.getElementById("resultado").classList.add("d-none");
  document.getElementById("resultado").innerHTML = "";
  document.getElementById("notaAnchor").classList.add("d-none");
  document.getElementById("notaGloria").classList.add("d-none");
document.getElementById("imagenProducto").style.display = "none";
}

document.addEventListener("click", function (e) {
  if (e.target && e.target.id === "verFotoBtn") {
    const producto = document.getElementById("producto").value;

    // Reemplazamos con los enlaces directos reales
    let imagenFrontalURL = "";
    let imagenPosteriorURL = "";

    if (producto === "Anchor") {
      imagenFrontalURL = "https://i.ibb.co/ks6vHTW0/A-1.png";
      imagenPosteriorURL = "https://i.ibb.co/Gv2VrqJn/A-2.png";
    } else if (producto === "Gloria") {
      imagenFrontalURL = "https://i.ibb.co/hJCRMFhh/G-1.png";
      imagenPosteriorURL = "https://i.ibb.co/5hd5957X/G-2.png";
    }

    // Abrimos una nueva ventana con ambas imágenes
    const nuevaVentana = window.open("", "_blank");
    nuevaVentana.document.write(`
      <html>
      <head>
        <title>Fotos del Producto</title>
        <style>
          body { font-family: Arial; padding: 20px; text-align: center; }
          img { max-width: 90%; height: auto; margin-bottom: 20px; border: 1px solid #ccc; }
        </style>
      </head>
      <body>
        <h2>${producto} - Vista Frontal</h2>
        <img src="${imagenFrontalURL}" alt="Frontal">
        <h2>${producto} - Vista Posterior</h2>
        <img src="${imagenPosteriorURL}" alt="Posterior">
      </body>
      </html>
    `);
  }
});
  </script>
</body>
</html>

